% cd /Users/thiwom/Desktop/A_MEA_Taufik%DATASET_ID = 1 ; % humanDATASET_ID = 2; % mouse 04%DATASET_ID = 3; % mouse 03for DATASET_ID=2:3        if 1        DATA_DIR =  'G:\Super2\Data\Optodata\';        RESDIR   =  'G:\Super2\Data\Optodata\';                filename ='Opto_DATA_0003.mat';%         if DATASET_ID == 1%             filename =  'Test_Data_4min_Human.mat'%             iNexPreFix = 'data01'%         elseif DATASET_ID == 2%             filename =  'Test_Data_004_714sec_Mouse.mat'%             iNexPreFix = 'mouse004'%         elseif DATASET_ID == 3%             filename =  'Test_Data_003_714sec_Mouse.mat'%             iNexPreFix = 'mouse003'%         end                                        in = load([DATA_DIR filename]);        iNexPreFix = 'spikes';        % in.S        %  total_nchan: 60        %            srate: 2.5000e+04        %     total_length: 715.5000        %          recdate: 'dmy:7_2_2013'        %          rectime: 'hms:20_45_43'        %         comments: ''        %            nchan: [1 60]        %            chans: [1x60 double]        %            fname: 'test_day_post2hr.mcd'        %            start: 185        %             stop: 388        %           length: 203        %             data: [5074999x60 double]        % figure, plot(in.S.data(:,1))                        dataraw = [];        fsample = in.S.srate;        dataraw.fsample  = fsample;        for iChan = 1:length(in.S.chans)            dataraw.label(iChan) = {[sprintf('SP%03d' ,in.S.chans(iChan))]};        end        dataraw.trial{1} = [in.S.data'];        dataraw.time{1}  = [(0:size(in.S.data,1)-1) ./ fsample];                        clear in            end        % ---high pass filter to get rid of low freq modulation    % figure, plot(dataraw.trial{1}(5,:)')        % --- get Local Field potential - filtering low pass at 200 Hz    for iCh=1:1        cfg            = [];        cfg.channel    = dataraw.label(iCh);'all'%[channels_lfp; Lchannels_lfp];        cfg.demean    = 'yes';        cfg.detrend   = 'yes';        %   cfg.dftfilter = 'yes';        %   cfg.dftfilter = 'no';        %end                hdr = [];        hdr.Fs = dataraw.fsample ;        hdr.nChan = 1;%length(dataraw.label);        hdr.nSamples = 0        hdr.nSamplesPre = 0        hdr.nTrials = 1        hdr.FirstTimeStamp = 0        hdr.TimeStampPerSample =  hdr.Fs/1000;%NaN;%        %         cfg.bpfilter = 'yes';%         cfg.bpfreq = [300 10000];%         cfg.bpfiltord = 6;%         cfg.bpfilttype = 'but';%         cfg.bpfiltdir ='twopass';%         if 0%             cfg.hpfilter = 'yes';%             cfg.hpfreq = [300];%             cfg.hpfiltord = 6;%             cfg.hpfilttype = 'but';%             cfg.hpfiltdir ='twopass';%         end%         %cfg.dftfreq   = F;%         [data] = ft_preprocessing(cfg,dataraw);%         %         if 0%             figure,%             sel = 300000:3000000;%             subplot(2,1,1), hold on,%             plot(dataraw.trial{1}(1,sel),'b-'), hold on,%             subplot(2,1,2), hold on,%             plot(data.trial{1}(sel),'r-'), hold on,%         end%         %         %         %for iL=1:length(dataraw.label)%         iL =1%         hdr.label = data.label(iL); % {'FP001'};%dataraw.label%         iNEXNAME = [RESDIR iNexPreFix '_' data.label{iL}]%         ft_write_data(iNEXNAME, data.trial{1}(iL,:),'dataformat','plexon_nex','header',hdr)%         fprintf('done with one nex %s',iNEXNAME)%         %end                        % LFP filtering        %cfg.bpfilter = 'yes';        cfg = [];        cfg.channel    = dataraw.label(iCh);'all'%[channels_lfp; Lchannels_lfp];        cfg.lpfilter = 'yes';        cfg.lpfreq = 100;        cfg.bpfiltord = 6;        cfg.bpfilttype = 'but';        cfg.bpfiltdir ='twopass';        [lfp_data] = ft_preprocessing(cfg,dataraw);                iL =1;        iNexPreFix = 'lfp';        hdr.label = data.label(iL); % {'FP001'};%dataraw.label        iNEXNAME = [RESDIR iNexPreFix '_' data.label{iL}]        ft_write_data(iNEXNAME, lfp_data.trial{1}(iL,:),'dataformat','plexon_nex','header',hdr)        fprintf('done with one nex %s',iNEXNAME);                % LFP filtering        cfg = [];        cfg.channel    = dataraw.label(iCh);'all'%[channels_lfp; Lchannels_lfp];        cfg.bpfilter = 'yes';        %cfg.lpfilter = 'yes';        cfg.bpfreq = [800 3000];        cfg.bpfiltord = 6;        cfg.bpfilttype = 'but';        cfg.bpfiltdir ='twopass';        mua_data = ft_preprocessing(cfg,dataraw);                iL =1;        iNexPreFix = 'mua';        hdr.label = data.label(iL); % {'FP001'};%dataraw.label        iNEXNAME = [RESDIR iNexPreFix '_' data.label{iL}]        ft_write_data(iNEXNAME, lfp_data.trial{1}(iL,:),'dataformat','plexon_nex','header',hdr)        fprintf('done with one nex %s',iNEXNAME);            end            clear datarawenddisp('done')return